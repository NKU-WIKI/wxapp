# RAG (Retrieval-Augmented Generation) API

该接口是智能问答的核心，结合了信息检索（Retrieval）和生成（Generation）两个阶段，能够根据知识库内容生成更准确、更丰富的答案。

## 1. 智能问答接口

`POST /api/agent/rag`

### a. 功能描述

1.  **查询理解与改写 (可选)**: 首先对用户的原始问题进行分析和改写，以便更好地在知识库中检索。
2.  **信息检索**: 使用改写后的查询在 Elasticsearch 索引中进行高效检索，召回最相关的文档片段。
3.  **答案生成**: 将原始问题和检索到的信息源整合后，交给大语言模型（LLM）生成最终的、自然的回答。
4.  **流式与非流式响应**: 支持一次性返回完整答案，也支持类似打字机效果的流式响应。

### b. 请求体参数

| 参数名 | 类型 | 是否必须 | 默认值 | 描述 |
| --- | --- | --- | --- | --- |
| `query` | `string` | 是 | | 用户的原始查询问题。 |
| `openid` | `string` | 是 | | 用户的唯一标识符，用于记录和未来可能的个性化。 |
| `stream` | `boolean` | 否 | `false` | 是否使用流式响应。`true` 为流式，`false` 为一次性返回。 |
| `platform` | `string` | 否 | `null` | 按平台筛选，支持 `wechat`, `website`, `market`, `wxapp`。多个用逗号 `,` 分隔。 |
| `max_results` | `integer`| 否 | `10` | 检索阶段从知识库召回的最大文档数量。 |
| `rewrite_query`| `boolean`| 否 | `false` | 是否启用查询改写功能。 |

### c. 请求示例 (非流式)

```bash
curl -X POST "http://127.0.0.1:8000/api/agent/rag" \
-H "Content-Type: application/json" \
-d '{
  "query": "南开大学有哪些知名校友？",
  "openid": "test_user_for_rag_api",
  "stream": false
}'
```

### d. 响应示例 (非流式, 成功)

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "original_query": "南开大学有哪些知名校友？",
    "rewritten_query": "南开大学有哪些知名校友？",
    "response": "南开大学有许多知名校友，他们在各自的领域取得了卓越的成就。以下是一些代表性校友及其贡献：\n\n1. **潘源**  \n   1989级校友，现任天津市肿瘤医院高级病房科主任，担任多个国家级和省级医学专业委员会的职务，同时也是南开大学校友总会理事和医学校友会理事长[1]。\n\n2. **张雅敏**  \n   1990级临床医学专业校友，现任天津市第一中心医院外科教研室主任、普通外科行政主任和肝胆外科科主任，并担任南开大学医学校友会副理事长[3]。\n\n3. **张中礼**  \n   1998级校友，天津医院小儿骨科主任，在中国医师协会骨科医师分会等多个国家级学术组织中担任重要职务，是小儿骨科领域的专家[4]。\n\n4. **李朝阳**  \n   2010级校友，天津市口腔医院口腔种植科医师，曾获天津市志愿服务先进个人等多项荣誉，专注于口腔种植学的研究与实践[5]。\n\n5. **林松**  \n   1991届旅游经济管理专业校友，曾多次创业并在旅游行业取得显著成就，受邀回校分享职业经验，为学生的就业规划提供指导[7]。\n\n6. **苏洪宇**  \n   南开大学旅游校友会会长、深圳市榜样旅游项目设计有限公司董事长，多次受邀回校开展职业规划讲座，分享文旅行业的前沿动态和创业经验[8]。\n\n这些校友不仅在专业领域表现出色，还积极回馈母校，为南开大学的发展和学生的成长贡献力量。",
    "sources": [
      {
        "title": "知名校友——潘源",
        "content": "1989级校友潘源，天津市肿瘤医院高级病房科主任。中国医师协会外科分会肿瘤外科专业委员会委员，天津医师协会微创外科专业委员会副主任委员，北京肿瘤学会胃癌专委会副主任委员，南开大学校友总会理事，南开大学医学校友会理事长。",
        "author": "",
        "platform": "website",
        "original_url": "https://medical.nankai.edu.cn/2021/0924/c7442a397738/page.htm",
        "relevance": 88.43759
      },
      {
        "title": "知名校友——张雅敏",
        "content": "张雅敏，1990级临床医学专业，现任天津市第一中心医院外科教研室主任，普通外科行政主任，肝胆外科科主任，南开大学医学校友会副理事长。",
        "author": "",
        "platform": "website",
        "original_url": "https://medical.nankai.edu.cn/2021/0924/c7442a397740/page.htm",
        "relevance": 83.05158
      }
    ],
    "suggested_questions": [],
    "format": "markdown",
    "retrieved_count": 10,
    "response_time": 21.483120441436768
  },
  "details": null,
  "timestamp": "2025-06-21T18:12:28.948620",
  "pagination": null
}
```

### e. 响应字段说明

- **data**: 核心响应数据对象
  - `original_query`: 用户输入的原始问题。
  - `rewritten_query`: 经过系统改写后的查询，用于内部检索。
  - `response`: LLM 生成的最终文本回答。
  - `sources`: 一个对象数组，列出了生成答案所依据的参考资料。每个对象包含 `title`, `content`, `original_url` 等字段。
  - `suggested_questions`: 一个字符串数组，包含模型建议的后续问题。
  - `response_time`: 服务器处理该请求的总耗时（秒）。 