<!-- 顶部导航栏 -->
<nav-bar title="发布帖子" showBack="{{true}}" />

<tab-bar
  tabs="{{tabTitles}}"
  activeTab="{{isMarkdownMode ? 1 : 0}}"
  equalWidth="{{true}}"
  fixed="{{true}}"
  bind:change="onModeTabChange"
/>

<view class="post-container">
  <!-- 表单内容 -->
  <view class="post-form">
    <!-- 标题输入 - 仅在非markdown模式下显示 -->
    <block wx:if="{{!isMarkdownMode}}">
      <input class="post-title" placeholder="请输入标题" value="{{form.title}}" 
        bindinput="onFormChange" data-field="title" maxlength="50" />
    </block>
    
    <!-- 内容输入/预览切换 -->
    <text-area
      value="{{form.content}}"
      placeholder="分享你的想法..."
      maxlength="300"
      height="300"
      showCount="{{true}}"
      markdownMode="{{isMarkdownMode}}"
      showToolbar="{{true}}"
      title="{{form.title}}"
      data-field="content"
      bindinput="onFormChange"
      bindimagetap="showImageUploader"
      bindpreviewchange="onPreviewChange"
      binderror="_showToptips"
    />
  </view>

  <!-- 标签栏 -->
  <view class="section-container">
    <view class="section-title">选择话题</view>
    <view class="tag-list">
      <view wx:for="{{['校园生活', '学习交流', '求助']}}" wx:key="*this" 
            bindtap="selectTag" 
            data-tag="{{item}}">
        <mp-badge content="{{'#' + item}}" ext-class="{{tagSelected[item] ? 'tag-badge-active' : 'tag-badge'}}"/>
      </view>
    </view>

    <!-- 自定义标签显示 -->
    <view class="custom-tag-list" wx:if="{{customTags.length > 0}}">
      <view wx:for="{{customTags}}" wx:key="*this" bindtap="removeCustomTag" data-tag="{{item}}">
        <mp-badge content="{{'#' + item}}" ext-class="{{tagSelected[item] ? 'tag-badge-active' : 'tag-badge'}}"/>
      </view>
    </view>

    <view class="tag-input-container">
      <input 
        class="tag-input" 
        placeholder="输入话题名称，回车添加" 
        value="{{tagInputValue}}" 
        bindinput="onTagInput" 
        bindconfirm="addTag"
      />
      <view class="tag-add-btn" bindtap="addTag">添加</view>
    </view>
  </view>

  <!-- 分类选择 -->
  <view class="section-container">
    <view class="section-title">选择分类</view>
    <category-tab
      tabs="{{tabItems}}"
      categoryId="{{categoryId}}"
    />
  </view>

  <!-- 底部设置 -->
  <view class="section-container">
    <view class="section-title">发布设置</view>
    <view class="setting-group">
      <button 
        wx:for="{{settingButtons}}" 
        wx:key="field"
        class="setting-btn {{form[item.field] ? 'active' : ''}}" 
        icon="{{item.icon}}"
        iconColor="{{form[item.field] ? '#5853e2' : '#666'}}"
        iconSize="{{item.iconSize}}"
        text="{{item.text}}"
        textColor="{{form[item.field] ? '#5853e2' : '#666'}}"
        textSize="26"
        bindtap="onSwitchChange"
        data-field="{{item.field}}"
        data-value="{{!form[item.field]}}"
      />
    </view>
  </view>

  <!-- 发布按钮 -->
  <button 
    class="submit-btn"
    text="发布"
    textColor="#000000"
    textSize="32"
    disabled="{{!canSubmit || submitting}}"
    loading="{{submitting}}"
    bindtap="submitForm"
  ></button>

  <!-- 加载中状态 -->
  <view class="loading-mask" wx:if="{{submitting}}">
    <view class="loading-content">
      <loading type="circle" color="#ffffff" />
      <text>发布中...</text>
    </view>
  </view>
</view> 